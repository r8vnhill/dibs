---
title: Tareas Personalizadas
---
import GithubRepoLink from "../../../src/components/GithubRepoLink";
import ReadingTime from '../../../src/components/ReadingTime';
import References from "../../../src/components/ReferencesComponent";
import TabItem from "@theme/TabItem";
import Tabs from "@theme/Tabs";

<ReadingTime/>
<GithubRepoLink user={"r8vnhill"} repo={"echo-app-kt"}/>
<GithubRepoLink user={"r8vnhill"} repo={"echo-app-groovy"}/>

\
Gradle no solo ofrece tareas predefinidas, sino que también permite definir **tareas personalizadas** para realizar acciones específicas dentro de tu proyecto. Estas tareas pueden variar en complejidad y se definen en los archivos `build.gradle.kts` o en otros archivos `*.gradle.kts`.

Para definir tareas personalizadas, podemos hacerlo en el módulo `convention-plugins`, dentro de un archivo como `playground.gradle.kts`. Utilizamos la función `tasks.register` para especificar el nombre y las acciones a ejecutar. Aquí tienes un ejemplo básico:

<Tabs groupId={"gradle"}>
    <TabItem value="Kotlin DSL" label="Kotlin DSL">
```kotlin title="convention-plugins/src/main/kotlin/playground.gradle.kts"
tasks.register("greet") {
    group = "Playground"
    description = "Prints a greeting message"
    println("Hello, Gradle!")
}
```
</TabItem>
<TabItem value="Groovy DSL" label="Groovy DSL">
```groovy title="convention-plugins/src/main/groovy/playground.gradle"
tasks.register("greet") {
    group = 'Playground'
    description = 'Prints a greeting message'
    println 'Hello, Gradle!'
}
```
</TabItem>
</Tabs>

Para que esta tarea se ejecute en el proyecto principal, debes aplicar el plugin correspondiente en el archivo `build.gradle.kts` del módulo principal:

<Tabs groupId={"gradle"}>
<TabItem value="Kotlin DSL" label="Kotlin DSL">
```kotlin title="build.gradle.kts"
plugins {
    id("jvm.conventions")
    id("playground")
}
```
</TabItem>
<TabItem value="Groovy DSL" label="Groovy DSL">
```groovy title="build.gradle"
plugins {
    id 'jvm.conventions'
    id 'playground'
}
```
</TabItem>
</Tabs>

Ahora puedes ejecutar la tarea con `./gradlew greet` y verás el mensaje impreso en la consola.

:::tip Ejercicio
<Tabs>
    <TabItem value="Enunciado" label="Enunciado">
        Cambia la definición de la tarea de `tasks.register` a `tasks.create` en el archivo `playground.gradle.kts`. ¿Qué sucede ahora si ejecutas `./gradlew build` en el proyecto? ¿Por qué?
    </TabItem>
    <TabItem value="Solución" label="Solución">
        Al ejecutar `./gradlew build`, se imprimirá el mensaje "Hello, Gradle!" a pesar de que no se haya llamado explícitamente a la tarea `greet`. El motivo es que al usar `tasks.create`, la tarea `greet` se configura y ejecuta su bloque de configuración inmediatamente durante la fase de configuración del build de Gradle.

        Esto significa que cualquier código dentro del bloque `{ ... }` de la tarea, como `println("Hello, Gradle!")`, se ejecuta en ese momento, independientemente de si la tarea `greet` se ejecuta o no durante la fase de ejecución.

        Por lo tanto, el mensaje se imprime al ejecutar cualquier tarea del proyecto, incluyendo `./gradlew build`, porque la fase de configuración siempre se ejecuta antes de la fase de ejecución en Gradle.

        En contraste, cuando usas `tasks.register`, la tarea se registra para una configuración diferida. El bloque de configuración no se ejecuta hasta que la tarea es requerida para su ejecución. Esto mejora el rendimiento al evitar configurar tareas que no se utilizan. Por eso, con `tasks.register`, el mensaje "Hello, Gradle!" no se imprime al ejecutar `./gradlew build`, a menos que la tarea `greet` sea llamada explícitamente.
    </TabItem>
</Tabs>
:::

## Acciones en Gradle

Nuestra implementación tiene un problema sutil, pero importante: el mensaje se imprime durante la configuración de Gradle, no durante la ejecución de la tarea. Para corregir esto, necesitamos usar **acciones**.

Las **acciones** son bloques de código que puedes agregar a una tarea para definir comportamientos específicos en momentos determinados durante su ciclo de vida. Las acciones más comunes son:

- **`doFirst`**: Se ejecuta **antes** de cualquier otra acción configurada.
- **`doLast`**: Se ejecuta **después** de todas las demás acciones configuradas.

## Ejemplo: Calculando la Secuencia de Fibonacci

Supongamos que queremos crear una tarea que calcule la secuencia de Fibonacci. Usaremos las acciones `doFirst` y `doLast` para estructurar las operaciones:

<Tabs groupId={"gradle"}>
<TabItem value="Kotlin DSL" label="Kotlin DSL">
```kotlin title="convention-plugins/src/main/kotlin/playground.gradle.kts"
tasks.register("fib") {
    group = "Playground"
    description = "Calculates the Fibonacci sequence up to the 10th number"

    var first = 0
    var second = 1

    doFirst {
        repeat(10) {
            print("$first ")
            second += first
            first = second - first
        }
    }

    doLast {
        println("\nThe 10th Fibonacci number is: $first")
    }
}
```
</TabItem>
<TabItem value="Groovy DSL" label="Groovy DSL">
```groovy title="convention-plugins/src/main/groovy/playground.gradle"
tasks.register("fib") {
    group = 'Playground'
    description = 'Calculates the Fibonacci sequence up to the 10th number'

    def first = 0
    def second = 1

    doFirst {
        (1..10).each {
            print "$first "
            second += first
            first = second - first
        }
    }

    doLast {
        println "\nThe 10th Fibonacci number is: $first"
    }
}
```
</TabItem>
</Tabs>

### ¿Qué está sucediendo aquí?

1. **`doFirst`**: Calcula los primeros 10 números de la secuencia de Fibonacci y los imprime.
2. **`doLast`**: Imprime el décimo número de la secuencia al final.

### Resultado

Cuando ejecutas esta tarea con `./gradlew fib`, verás la siguiente salida:

```plaintext
> Task :fib
0 1 1 2 3 5 8 13 21 34
The 10th Fibonacci number is: 55
```

## Dependencias entre Tareas

En Gradle, es común que ciertas tareas dependan de otras. Para esto, puedes usar el método `dependsOn`. Por ejemplo, si queremos que la tarea `fib` dependa de una tarea `message`, podemos hacerlo así:

<Tabs groupId={"gradle"}>
<TabItem value="Kotlin DSL" label="Kotlin DSL">
```kotlin title="convention-plugins/src/main/kotlin/playground.gradle.kts"
// ...
tasks.register("message") {
    group = "Playground"
    description = "Prints a message before calculating the Fibonacci sequence"
    doFirst {
        println("Calculating the Fibonacci sequence...")
    }
}

// highlight-next-line
tasks.named("fib") {
    dependsOn("message")
}
```
</TabItem>
<TabItem value="Groovy DSL" label="Groovy DSL">
```groovy title="convention-plugins/src/main/groovy/playground.gradle"
// ...
tasks.register('message') {
    group = 'Playground'
    description = 'Prints a message before calculating the Fibonacci sequence'
    doFirst {
        println 'Calculating the Fibonacci sequence...'
    }
}

// highlight-next-line
tasks.named('fib') {
    dependsOn tasks.message
}
```
</TabItem>
</Tabs>

Aquí noten que hemos usado `tasks.named("fib")` en lugar de `tasks.register("fib")` para obtener la tarea `fib` ya definida y agregarle la dependencia.

Esto hace que `message` se ejecute antes de `fib`, y el resultado en la consola será algo como:

```plaintext
> Task :message
Calculating the Fibonacci sequence...

> Task :fib
0 1 1 2 3 5 8 13 21 34
The 10th Fibonacci number is: 55
```

## Ejemplo Práctico: Contar el Tamaño del Proyecto Compilado

Un ejercicio útil es crear una tarea personalizada que calcule el tamaño de los archivos compilados del proyecto. Además, haremos que esta tarea dependa de `compileKotlin` para asegurarnos de que el código se compile antes de contar el tamaño.

:::tip Ejercicio
<Tabs>
    <TabItem value="Ejercicio" label="Ejercicio">
        Crea una tarea en Gradle que calcule el tamaño de los archivos compilados de tu proyecto.

        - Usa `fileTree("ruta").files` para obtener los archivos.
        - Utiliza `length()` para calcular el tamaño.
        - Asegúrate de que la tarea dependa de `compileKotlin`.
    </TabItem>
    <TabItem value="Solución" label="Solución">
        <Tabs groupId={"gradle"}>
            <TabItem value="Kotlin DSL" label="Kotlin DSL">
            ```kotlin title="convention-plugins/src/main/kotlin/playground.gradle.kts"
            tasks.register("countCompiledSize") {
                group = "build"
                description = "Counts the size of the compiled classes"
                dependsOn("compileKotlin")

                doLast {
                    val files = fileTree("app/build/classes/kotlin/main").files +
                        fileTree("lib/build/classes/kotlin/main").files
                    var size = 0L
                    for (file in files) {
                        size += file.length()
                    }
                    println("The total size of the compiled classes is $size bytes")
                }
            }
            ```
            </TabItem>
            <TabItem value="Groovy DSL" label="Groovy DSL">
            ```groovy title="convention-plugins/src/main/groovy/playground.gradle"
            tasks.register('countCompiledSize') {
                group = 'build'
                description = 'Counts the size of the compiled classes'
                dependsOn(tasks.compileKotlin)

                doLast {
                    def files = fileTree('app/build/classes/kotlin/main').files +
                        fileTree('lib/build/classes/kotlin/main').files
                    def size = 0L
                    files.each { file ->
                        size += file.length()
                    }
                    println("The total size of the compiled classes is ${size} bytes")
                }
            }
            ```
            </TabItem>
        </Tabs>
    </TabItem>
    <TabItem value={"Solución (más corta)"} label={"Solución (más corta)"}>
        <Tabs groupId={"gradle"}>
            <TabItem value="Kotlin DSL" label="Kotlin DSL">
                ```kotlin title="convention-plugins/src/main/kotlin/playground.gradle.kts"
                tasks.register("countCompiledSize") {
                    group = "build"
                    description = "Counts the size of the compiled classes"
                    dependsOn("compileKotlin")

                    doLast {
                        val files = fileTree("app/build/classes/kotlin/main").files +
                            fileTree("lib/build/classes/kotlin/main").files
                        val size = files.sumOf { it.length() }
                        println("The total size of the compiled classes is $size bytes")
                    }
                }
                ```
            </TabItem>
            <TabItem value="Groovy DSL" label="Groovy DSL">
                ```groovy title="convention-plugins/src/main/groovy/playground.gradle"
                tasks.register("countCompiledSize") {
                    group = "build"
                    description = "Counts the size of the compiled classes"
                    dependsOn("compileKotlin")

                    doLast {
                        def files = fileTree("app/build/classes/kotlin/main").files +
                            fileTree("lib/build/classes/kotlin/main").files
                        def size = files.sum { it.length() }
                        println("The total size of the compiled classes is $size bytes")
                    }
                }
                ```
            </TabItem>
        </Tabs>
    </TabItem>
</Tabs>
:::

## Tareas Basadas en Otras Tareas

Otra forma de crear tareas personalizadas en Gradle es basándolas en tareas existentes. Esto es útil si quieres
extender o agregar funcionalidades a una tarea predefinida. Por ejemplo, si queremos crear una tarea que copie los
archivos compilados a un directorio específico después de la compilación, podemos usar la tarea `Copy` y configurarla
para que dependa de `compileKotlin`.

<Tabs groupId={"gradle"}>
<TabItem value="Kotlin DSL" label="Kotlin DSL">
```kotlin title="convention-plugins/src/main/kotlin/playground.gradle.kts"
tasks.register<Copy>("copyCompiledClasses") {
    group = "build"
    description = "Copy the compiled classes to a specific directory"
    dependsOn("compileKotlin")
    from("app/build/classes/kotlin/main")
    into("compiled-classes")
}
```
</TabItem>
<TabItem value="Groovy DSL" label="Groovy DSL">
```groovy title="convention-plugins/src/main/groovy/playground.gradle"
tasks.register('copyCompiledClasses', Copy) {
    group = 'build'
    description = 'Copy the compiled classes to a specific directory'
    dependsOn tasks.compileKotlin
    from 'app/build/classes/kotlin/main'
    into 'compiled-classes'
}
```
</TabItem>
</Tabs>

Esta tarea copiará los archivos compilados al directorio `compiled-classes` después de que se haya completado la compilación.

### Otros Ejemplos en Diferentes Herramientas y Lenguajes

A continuación, se muestran ejemplos de cómo podrías definir tareas similares en otras plataformas.

- **npm (JavaScript/Node.js)**:
    ```json
    "scripts": {
        "build": "webpack",
        "clean": "rimraf dist",
        "fibonacci": "node fibonacci.js"
    }
    ```
    Archivo `fibonacci.js`:
    ```javascript
    function fibonacci(n) {
        let a = 0, b = 1, f = 1;
        for (let i = 2; i <= n; i++) {
            f = a + b;
            a = b;
            b = f;
        }
        return f;
    }
    console.log(fibonacci(10));
    ```

- **Make (C/C++)**:
    ```make
    all: build fibonacci

    build:
        gcc -o app main.c

    fibonacci:
        @echo "Calculating Fibonacci sequence..."
        @./app
    ```

- **Cargo (Rust)**:
    En `Cargo.toml`:
    ```toml
    [package]
    name = "fibonacci"
    version = "0.1.0"

    [build-dependencies]
    ```
    En `build.rs`:
    ```rust
    fn main() {
        println!("Calculating Fibonacci...");
        let mut a = 0;
        let mut b = 1;
        for _ in 0..10 {
            let temp = a;
            a = b;
            b = temp + b;
            print!("{} ", a);
        }
        println!();
    }
    ```

### Resumen

Hemos aprendido cómo definir **tareas personalizadas** en Gradle, usando acciones `doFirst` y `doLast`, así como establecer dependencias entre tareas. También exploramos cómo crear tareas basadas en otras tareas existentes y cómo implementar ejemplos similares en otras plataformas como npm, Make y Cargo.

<References references={[
    {
        title: "4. Build Script Essentials",
        bookTitle: "Gradle in Action",
        pages: "75–104",
        location: "Shelter Island, NY",
        publisher: "Manning",
        year: "2014",
        type: "book",
        author: 'Muschko, Benjamin and Dockter, Hans',
    },
    {
        title: "Using Tasks",
        siteOrAuthor: "Gradle",
        url: "https://docs.gradle.org/current/userguide/tutorial_using_tasks.html",
        accessedDate: "10 de septiembre de 2024",
        type: "web"
    }
]}/>
